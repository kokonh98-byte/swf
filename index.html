<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéÆ Flash Game - –û–ø—Ç–∏–º–∏–∑–∏—Ä–∞–Ω–∞</title>
    <!-- –¢–µ—Å—Ç–≤–∞–º–µ —Ä–∞–∑–ª–∏—á–Ω–∏ –≤–µ—Ä—Å–∏–∏ –Ω–∞ Ruffle –∑–∞ —Å–∫–æ—Ä–æ—Å—Ç -->
    <script src="https://unpkg.com/@ruffle-rs/ruffle@0.1.0-nightly.2024.03.17"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #fff;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #4cc9f0;
            width: 100%;
            max-width: 900px;
        }
        
        h1 {
            color: #4cc9f0;
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        
        .subtitle {
            color: #b8b8d1;
            font-size: 1.1rem;
        }
        
        .main-container {
            display: flex;
            flex-direction: column;
            gap: 25px;
            width: 100%;
            max-width: 900px;
        }
        
        .game-wrapper {
            position: relative;
            width: 100%;
            background: #0d0d1a;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border: 3px solid #2d2d5a;
        }
        
        #game-container {
            width: 100%;
            min-height: 600px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(13, 13, 26, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10;
            transition: opacity 0.3s;
        }
        
        .spinner {
            width: 60px;
            height: 60px;
            border: 5px solid #2d2d5a;
            border-top: 5px solid #4cc9f0;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .control-panel {
            background: #1a1a2e;
            padding: 20px;
            border-radius: 12px;
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            justify-content: center;
            border: 2px solid #2d2d5a;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #4cc9f0 0%, #4361ee 100%);
            color: white;
        }
        
        .btn-secondary {
            background: #2d2d5a;
            color: #b8b8d1;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%);
            color: white;
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #ff9800 0%, #ef6c00 100%);
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .status-panel {
            background: #1a1a2e;
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid #4cc9f0;
        }
        
        .status-title {
            color: #4cc9f0;
            margin-bottom: 10px;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        #status-text {
            color: #b8b8d1;
            line-height: 1.6;
        }
        
        .performance {
            display: flex;
            gap: 15px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .perf-item {
            background: #0d0d1a;
            padding: 10px 15px;
            border-radius: 8px;
            min-width: 120px;
        }
        
        .perf-label {
            color: #7b7ba1;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }
        
        .perf-value {
            color: #4cc9f0;
            font-size: 1.5rem;
            font-weight: bold;
            font-family: monospace;
        }
        
        .fps-good { color: #4CAF50; }
        .fps-ok { color: #ff9800; }
        .fps-bad { color: #f44336; }
        
        .error-box {
            background: #2d1a1a;
            color: #ff6b6b;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #f44336;
            margin-top: 20px;
            display: none;
        }
        
        .debug-info {
            background: #1a2d1a;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-family: monospace;
            font-size: 0.9rem;
            color: #6bff6b;
            display: none;
            max-height: 200px;
            overflow-y: auto;
        }
        
        footer {
            margin-top: 30px;
            color: #7b7ba1;
            text-align: center;
            font-size: 0.9rem;
            padding: 20px;
            border-top: 1px solid #2d2d5a;
            width: 100%;
            max-width: 900px;
        }
        
        @media (max-width: 768px) {
            .control-panel {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
            
            #game-container {
                min-height: 400px;
            }
            
            h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üéÆ Flash –ò–≥—Ä–∞ - –û–ø—Ç–∏–º–∏–∑–∏—Ä–∞–Ω–∞ –í–µ—Ä—Å–∏—è</h1>
        <p class="subtitle">–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞ –º–∞–∫—Å–∏–º–∞–ª–Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª–Ω–æ—Å—Ç</p>
    </div>
    
    <div class="main-container">
        <div class="game-wrapper">
            <div class="loading-overlay" id="loadingOverlay">
                <div class="spinner"></div>
                <p style="color: #b8b8d1; margin-top: 15px;">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–∞–Ω –µ–º—É–ª–∞—Ç–æ—Ä...</p>
            </div>
            <div id="game-container"></div>
        </div>
        
        <div class="performance">
            <div class="perf-item">
                <div class="perf-label">FPS (–°–∫–æ—Ä–æ—Å—Ç)</div>
                <div class="perf-value" id="fpsCounter">--</div>
            </div>
            <div class="perf-item">
                <div class="perf-label">–ó–∞—Ä–µ–∂–¥–∞–Ω–µ</div>
                <div class="perf-value" id="loadStatus">0%</div>
            </div>
            <div class="perf-item">
                <div class="perf-label">–†–µ–∂–∏–º</div>
                <div class="perf-value" id="performanceMode">–ê–≤—Ç–æ</div>
            </div>
        </div>
        
        <div class="control-panel">
            <button class="btn btn-primary" id="btnLoad">
                <span>‚ñ∂Ô∏è</span> –°—Ç–∞—Ä—Ç–∏—Ä–∞–π –ò–≥—Ä–∞—Ç–∞
            </button>
            <button class="btn btn-secondary" id="btnRestart">
                <span>üîÑ</span> –†–µ—Å—Ç–∞—Ä—Ç
            </button>
            <button class="btn btn-secondary" id="btnFullscreen">
                <span>‚õ∂</span> –¶—è–ª –ï–∫—Ä–∞–Ω
            </button>
            <button class="btn btn-success" id="btnTurbo">
                <span>‚ö°</span> –¢–£–†–ë–û –†–µ–∂–∏–º
            </button>
            <button class="btn btn-warning" id="btnDebug">
                <span>üîß</span> –î–µ–±—ä–≥ –ò–Ω—Ñ–æ
            </button>
        </div>
        
        <div class="status-panel">
            <div class="status-title">
                <span>üìä</span> –°—Ç–∞—Ç—É—Å –Ω–∞ –°–∏—Å—Ç–µ–º–∞—Ç–∞
            </div>
            <div id="status-text">
                –°–∏—Å—Ç–µ–º–∞—Ç–∞ –µ –≥–æ—Ç–æ–≤–∞. –ù–∞—Ç–∏—Å–Ω–µ—Ç–µ "–°—Ç–∞—Ä—Ç–∏—Ä–∞–π –ò–≥—Ä–∞—Ç–∞" –∑–∞ –¥–∞ –∑–∞–ø–æ—á–Ω–µ—Ç–µ.
            </div>
            <div class="debug-info" id="debugInfo"></div>
        </div>
        
        <div class="error-box" id="errorBox">
            <strong>‚ö†Ô∏è –í—ä–∑–Ω–∏–∫–Ω–∞ –≥—Ä–µ—à–∫–∞:</strong>
            <div id="errorText"></div>
        </div>
    </div>
    
    <footer>
        <p>–û–ø—Ç–∏–º–∏–∑–∏—Ä–∞–Ω–∞ Flash –∏–≥—Ä–∞ —Å Ruffle –µ–º—É–ª–∞—Ç–æ—Ä | –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª–Ω–æ—Å—Ç | GitHub Pages</p>
        <p style="margin-top: 10px; font-size: 0.8rem; color: #5a5a8a;">
            –°—ä–≤–µ—Ç: –ò–∑–ø–æ–ª–∑–≤–∞–π—Ç–µ "–¢–£–†–ë–û –†–µ–∂–∏–º" –∞–∫–æ –∏–≥—Ä–∞—Ç–∞ –µ –±–∞–≤–Ω–∞. –ü—Ä–µ–≤–∫–ª—é—á–µ—Ç–µ –Ω–∞ "–¶—è–ª –ï–∫—Ä–∞–Ω" –∑–∞ –ø–æ-–¥–æ–±—Ä–æ –∏–∑–∂–∏–≤—è–≤–∞–Ω–µ.
        </p>
    </footer>

    <script>
        // ===== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –ò –°–™–°–¢–û–Ø–ù–ò–ï =====
        const CONFIG = {
            swfFile: 'game.swf',
            ruffleVersions: [
                'https://unpkg.com/@ruffle-rs/ruffle@0.1.0-nightly.2024.03.17',
                'https://unpkg.com/@ruffle-rs/ruffle@0.1.0-nightly.2023.12.31',
                'https://unpkg.com/@ruffle-rs/ruffle'
            ],
            currentVersionIndex: 0
        };
        
        let gamePlayer = null;
        let fpsCounter = 0;
        let lastFpsUpdate = performance.now();
        let frameCount = 0;
        let isTurboMode = false;
        let gameLoaded = false;
        
        // ===== –ï–õ–ï–ú–ï–ù–¢–ò –û–¢ DOM =====
        const elements = {
            gameContainer: document.getElementById('game-container'),
            loadingOverlay: document.getElementById('loadingOverlay'),
            fpsCounter: document.getElementById('fpsCounter'),
            loadStatus: document.getElementById('loadStatus'),
            performanceMode: document.getElementById('performanceMode'),
            statusText: document.getElementById('status-text'),
            errorBox: document.getElementById('errorBox'),
            errorText: document.getElementById('errorText'),
            debugInfo: document.getElementById('debugInfo'),
            btnLoad: document.getElementById('btnLoad'),
            btnRestart: document.getElementById('btnRestart'),
            btnFullscreen: document.getElementById('btnFullscreen'),
            btnTurbo: document.getElementById('btnTurbo'),
            btnDebug: document.getElementById('btnDebug')
        };
        
        // ===== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ù–ê RUFFLE =====
        function initRuffle() {
            updateStatus('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–∞–Ω Flash –µ–º—É–ª–∞—Ç–æ—Ä...');
            
            window.RufflePlayer = window.RufflePlayer || {};
            window.RufflePlayer.config = {
                // –û—Å–Ω–æ–≤–Ω–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                autoplay: 'on',
                unmuteOverlay: 'hidden',
                letterbox: 'off',
                warnOnUnsupportedContent: false,
                contextMenu: false,
                showSwfDownload: false,
                
                // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª–Ω–æ—Å—Ç
                preferredRenderer: 'canvas', // canvas –µ –ø–æ-—Å—Ç–∞–±–∏–ª–µ–Ω
                upgradeToHttps: false,
                maxExecutionDuration: { secs: 45, nanos: 0 },
                logLevel: 'warn', // –ù–∞–º–∞–ª—è–≤–∞–º–µ –ª–æ–≥–æ–≤–µ—Ç–µ
                
                // –ï–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª–Ω–∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
                polyfills: false,
                openUrlMode: 'deny'
            };
            
            setTimeout(() => {
                if (window.RufflePlayer && window.RufflePlayer.newest) {
                    updateStatus('Ruffle –µ–º—É–ª–∞—Ç–æ—Ä—ä—Ç –µ –∑–∞—Ä–µ–¥–µ–Ω —É—Å–ø–µ—à–Ω–æ!');
                    elements.loadingOverlay.style.opacity = '0';
                    setTimeout(() => {
                        elements.loadingOverlay.style.display = 'none';
                    }, 300);
                    enableControls();
                } else {
                    updateStatus('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ Ruffle. –û–ø–∏—Ç–≤–∞–º –∞–ª—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∞ –≤–µ—Ä—Å–∏—è...', true);
                    tryAlternativeRuffle();
                }
            }, 1000);
        }
        
        // ===== –ó–ê–†–ï–ñ–î–ê–ù–ï –ù–ê –ò–ì–†–ê–¢–ê =====
        function loadGame() {
            if (!window.RufflePlayer || !window.RufflePlayer.newest) {
                showError('Ruffle –µ–º—É–ª–∞—Ç–æ—Ä—ä—Ç –Ω–µ –µ –∑–∞—Ä–µ–¥–µ–Ω. –ú–æ–ª—è –∏–∑—á–∞–∫–∞–π—Ç–µ.');
                return;
            }
            
            resetGameContainer();
            updateStatus('–ó–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –∏–≥—Ä–∞—Ç–∞ —Å –æ–ø—Ç–∏–º–∏–∑–∏—Ä–∞–Ω–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏...');
            elements.btnLoad.disabled = true;
            
            try {
                const ruffle = window.RufflePlayer.newest();
                
                // –ü—Ä–∏–ª–∞–≥–∞–Ω–µ –Ω–∞ —Ç—É—Ä–±–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–∫–æ –µ –∞–∫—Ç–∏–≤–∏—Ä–∞–Ω —Ä–µ–∂–∏–º–∞
                if (isTurboMode) {
                    applyTurboSettings(ruffle);
                }
                
                gamePlayer = ruffle.createPlayer();
                gamePlayer.style.width = '100%';
                gamePlayer.style.height = '100%';
                gamePlayer.style.minHeight = '600px';
                gamePlayer.style.display = 'block';
                
                elements.gameContainer.appendChild(gamePlayer);
                
                // –ó–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ SWF —Ñ–∞–π–ª–∞
                gamePlayer.load(CONFIG.swfFile)
                    .then(() => {
                        gameLoaded = true;
                        updateStatus('‚úÖ –ò–≥—Ä–∞—Ç–∞ –µ –∑–∞—Ä–µ–¥–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!', false);
                        startPerformanceMonitoring();
                        elements.loadStatus.textContent = '100%';
                        elements.btnRestart.disabled = false;
                        
                        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤–∫–ª—é—á–≤–∞–Ω–µ –Ω–∞ –ø—ä–ª–Ω–∏—è –µ–∫—Ä–∞–Ω –∑–∞ –ø–æ-–¥–æ–±—Ä–æ –∏–∑–∂–∏–≤—è–≤–∞–Ω–µ
                        setTimeout(() => {
                            if (window.innerWidth > 1024) {
                                updateStatus('–°—ä–≤–µ—Ç: –ù–∞—Ç–∏—Å–Ω–µ—Ç–µ "–¶—è–ª –ï–∫—Ä–∞–Ω" –∑–∞ –ø–æ-–¥–æ–±—Ä–æ –∏–∑–∂–∏–≤—è–≤–∞–Ω–µ.', false);
                            }
                        }, 2000);
                    })
                    .catch(error => {
                        showError(`–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –∏–≥—Ä–∞—Ç–∞: ${error.message}`);
                        elements.btnLoad.disabled = false;
                        logDebug(`–ì—Ä–µ—à–∫–∞: ${error.stack || error}`);
                    });
                    
                // –°–∏–º—É–ª–∏—Ä–∞–º–µ –ø—Ä–æ–≥—Ä–µ—Å –Ω–∞ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ
                simulateLoadProgress();
                
            } catch (error) {
                showError(`–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ —Å—ä–∑–¥–∞–≤–∞–Ω–µ –Ω–∞ –∏–≥—Ä–∞—á: ${error.message}`);
                elements.btnLoad.disabled = false;
            }
        }
        
        // ===== –¢–£–†–ë–û –†–ï–ñ–ò–ú (–û–ü–¢–ò–ú–ò–ó–ê–¶–ò–ò) =====
        function applyTurboSettings(ruffleInstance) {
            updateStatus('‚ö° –ê–∫—Ç–∏–≤–∏—Ä–∞–Ω–µ –Ω–∞ –¢–£–†–ë–û —Ä–µ–∂–∏–º (–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∑–∞ —Å–∫–æ—Ä–æ—Å—Ç)...');
            
            // –ï–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª–Ω–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª–Ω–æ—Å—Ç
            try {
                // –ù–∞–º–∞–ª—è–≤–∞–Ω–µ –Ω–∞ –∫–∞—á–µ—Å—Ç–≤–æ—Ç–æ –∑–∞ –ø–æ-–≤–∏—Å–æ–∫ FPS
                if (gamePlayer) {
                    gamePlayer.style.imageRendering = 'pixelated';
                    gamePlayer.style.transform = 'translateZ(0)'; // –•–∞—Ä–¥—É–µ—Ä–Ω–æ —É—Å–∫–æ—Ä–µ–Ω–∏–µ
                }
                
                // –ü—Ä–æ–º—è–Ω–∞ –Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è—Ç–∞
                ruffleInstance.config.preferredRenderer = 'canvas';
                ruffleInstance.config.logLevel = 'error'; // –û—â–µ –ø–æ-–º–∞–ª–∫–æ –ª–æ–≥–æ–≤–µ
                
                elements.performanceMode.textContent = '–¢–£–†–ë–û';
                elements.performanceMode.className = 'perf-value fps-good';
                
            } catch (e) {
                logDebug(`–ù–µ—É—Å–ø–µ—à–Ω–∞ —Ç—É—Ä–±–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: ${e.message}`);
            }
        }
        
        function toggleTurboMode() {
            isTurboMode = !isTurboMode;
            
            if (isTurboMode) {
                elements.btnTurbo.innerHTML = '<span>‚ö°</span> –ò–ó–ö–õ. –¢–£–†–ë–û';
                elements.btnTurbo.classList.remove('btn-success');
                elements.btnTurbo.classList.add('btn-warning');
                updateStatus('–¢–£–†–ë–û —Ä–µ–∂–∏–º –∞–∫—Ç–∏–≤–∏—Ä–∞–Ω. –û–ø–∏—Ç–≤–∞–º –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏...');
                
                if (gameLoaded && gamePlayer) {
                    applyTurboSettings(window.RufflePlayer.newest());
                }
            } else {
                elements.btnTurbo.innerHTML = '<span>‚ö°</span> –¢–£–†–ë–û –†–µ–∂–∏–º';
                elements.btnTurbo.classList.remove('btn-warning');
                elements.btnTurbo.classList.add('btn-success');
                elements.performanceMode.textContent = '–ù–æ—Ä–º–∞–ª–µ–Ω';
                elements.performanceMode.className = 'perf-value';
                updateStatus('–¢–£–†–ë–û —Ä–µ–∂–∏–º –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–∞–Ω.');
            }
        }
        
        // ===== –ú–û–ù–ò–¢–û–†–ò–ù–ì –ù–ê –ü–†–û–ò–ó–í–û–î–ò–¢–ï–õ–ù–û–°–¢–¢–ê =====
        function startPerformanceMonitoring() {
            // FPS –±—Ä–æ—è—á
            function updateFPS() {
                const now = performance.now();
                frameCount++;
                
                if (now - lastFpsUpdate >= 1000) {
                    const fps = Math.round((frameCount * 1000) / (now - lastFpsUpdate));
                    
                    // –û–±–Ω–æ–≤—è–≤–∞–Ω–µ –Ω–∞ –¥–∏—Å–ø–ª–µ—è
                    elements.fpsCounter.textContent = fps;
                    
                    // –¶–≤–µ—Ç–æ–≤–æ –∫–æ–¥–∏—Ä–∞–Ω–µ —Å–ø–æ—Ä–µ–¥ FPS
                    if (fps >= 30) {
                        elements.fpsCounter.className = 'perf-value fps-good';
                    } else if (fps >= 15) {
                        elements.fpsCounter.className = 'perf-value fps-ok';
                    } else {
                        elements.fpsCounter.className = 'perf-value fps-bad';
                    }
                    
                    frameCount = 0;
                    lastFpsUpdate = now;
                }
                
                if (gameLoaded) {
                    requestAnimationFrame(updateFPS);
                }
            }
            
            // –°—Ç–∞—Ä—Ç–∏—Ä–∞–Ω–µ –Ω–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
            if (gamePlayer) {
                gamePlayer.addEventListener('frame', () => {
                    frameCount++;
                });
            }
            
            requestAnimationFrame(updateFPS);
        }
        
        // ===== –ü–û–ú–û–©–ù–ò –§–£–ù–ö–¶–ò–ò =====
        function updateStatus(message, isWarning = false) {
            elements.statusText.innerHTML = message;
            elements.statusText.style.color = isWarning ? '#ff9800' : '#b8b8d1';
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ª–æ–≥–≤–∞–Ω–µ –≤ –¥–µ–±—ä–≥ –ø–∞–Ω–µ–ª–∞
            logDebug(`[${new Date().toLocaleTimeString()}] ${message}`);
        }
        
        function showError(message) {
            elements.errorText.textContent = message;
            elements.errorBox.style.display = 'block';
            logDebug(`[–ì–†–ï–®–ö–ê] ${message}`);
        }
        
        function logDebug(message) {
            const debugElement = elements.debugInfo;
            debugElement.innerHTML += message + '\n';
            debugElement.scrollTop = debugElement.scrollHeight;
        }
        
        function resetGameContainer() {
            if (gamePlayer) {
                try {
                    elements.gameContainer.removeChild(gamePlayer);
                } catch (e) {}
                gamePlayer = null;
            }
            gameLoaded = false;
            elements.gameContainer.innerHTML = '';
            elements.loadStatus.textContent = '0%';
            elements.fpsCounter.textContent = '--';
            elements.fpsCounter.className = 'perf-value';
            elements.errorBox.style.display = 'none';
        }
        
        function simulateLoadProgress() {
            let progress = 0;
            const interval = setInterval(() => {
                if (progress < 90 && !gameLoaded) {
                    progress += Math.random() * 15;
                    if (progress > 90) progress = 90;
                    elements.loadStatus.textContent = Math.round(progress) + '%';
                } else if (gameLoaded) {
                    clearInterval(interval);
                } else {
                    clearInterval(interval);
                }
            }, 300);
        }
        
        function tryAlternativeRuffle() {
            CONFIG.currentVersionIndex++;
            
            if (CONFIG.currentVersionIndex < CONFIG.ruffleVersions.length) {
                updateStatus(`–û–ø–∏—Ç–≤–∞–º –∞–ª—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∞ –≤–µ—Ä—Å–∏—è –Ω–∞ Ruffle (${CONFIG.currentVersionIndex + 1}/3)...`);
                
                // –ü—Ä–µ–º–∞—Ö–≤–∞–º–µ —Å—Ç–∞—Ä–∏—è —Å–∫—Ä–∏–ø—Ç
                const oldScript = document.querySelector('script[src*="ruffle"]');
                if (oldScript) oldScript.remove();
                
                // –î–æ–±–∞–≤—è–º–µ –Ω–æ–≤–∞ –≤–µ—Ä—Å–∏—è
                const newScript = document.createElement('script');
                newScript.src = CONFIG.ruffleVersions[CONFIG.currentVersionIndex];
                newScript.onload = initRuffle;
                document.head.appendChild(newScript);
            } else {
                showError('–í—Å–∏—á–∫–∏ –æ–ø–∏—Ç–∏ –∑–∞ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ Ruffle –Ω–µ—É—Å–ø–µ—à–Ω–∏. –ú–æ–ª—è –æ–ø—Ä–µ—Å–Ω–µ—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ç–∞.');
            }
        }
        
        function enableControls() {
            elements.btnLoad.disabled = false;
            elements.btnTurbo.disabled = false;
            elements.btnDebug.disabled = false;
            elements.btnFullscreen.disabled = false;
        }
        
        // ===== –°–õ–£–®–ê–¢–ï–õ–ò –ù–ê –°–™–ë–ò–¢–ò–Ø =====
        elements.btnLoad.addEventListener('click', loadGame);
        
        elements.btnRestart.addEventListener('click', () => {
            updateStatus('–†–µ—Å—Ç–∞—Ä—Ç–∏—Ä–∞–Ω–µ –Ω–∞ –∏–≥—Ä–∞—Ç–∞...');
            loadGame();
        });
        
        elements.btnFullscreen.addEventListener('click', () => {
            const element = elements.gameContainer;
            if (element.requestFullscreen) {
                element.requestFullscreen();
            } else if (element.webkitRequestFullscreen) {
                element.webkitRequestFullscreen();
            } else if (element.msRequestFullscreen) {
                element.msRequestFullscreen();
            }
            updateStatus('–†–µ–∂–∏–º –Ω–∞ —Ü—è–ª –µ–∫—Ä–∞–Ω –∞–∫—Ç–∏–≤–∏—Ä–∞–Ω. –ù–∞—Ç–∏—Å–Ω–µ—Ç–µ ESC –∑–∞ –∏–∑—Ö–æ–¥.');
        });
        
        elements.btnTurbo.addEventListener('click', toggleTurboMode);
        
        elements.btnDebug.addEventListener('click', () => {
            const debugElement = elements.debugInfo;
            debugElement.style.display = debugElement.style.display === 'block' ? 'none' : 'block';
            updateStatus(debugElement.style.display === 'block' ? 
                '–î–µ–±—ä–≥ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –≤–∫–ª—é—á–µ–Ω–∞.' : '–î–µ–±—ä–≥ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∏–∑–∫–ª—é—á–µ–Ω–∞.');
        });
        
        // ===== –°–¢–ê–†–¢–ò–†–ê–ù–ï –ü–†–ò –ó–ê–†–ï–ñ–î–ê–ù–ï =====
        document.addEventListener('DOMContentLoaded', initRuffle);
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Å—Ç–∞—Ä—Ç–∏—Ä–∞–Ω–µ –Ω–∞ –∏–≥—Ä–∞—Ç–∞ —Å–ª–µ–¥ 2 —Å–µ–∫—É–Ω–¥–∏
        window.addEventListener('load', () => {
            setTimeout(() => {
                if (window.RufflePlayer && window.RufflePlayer.newest) {
                    updateStatus('–°–∏—Å—Ç–µ–º–∞—Ç–∞ –µ –≥–æ—Ç–æ–≤–∞. –°—Ç–∞—Ä—Ç–∏—Ä–∞–Ω–µ –Ω–∞ –∏–≥—Ä–∞—Ç–∞...');
                    loadGame();
                }
            }, 2000);
        });
    </script>
</body>
</html>
